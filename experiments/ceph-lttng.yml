# Author: Michael Sevilla
# Create a Ceph development node (with the source code) and start it on the localhost

- hosts: Workers
  roles: [cleanup]

- hosts: Builder
  roles: [lttng-build]
  vars: 
    - BUILD_THREADS: 64
    - CEPH_PKGS: --with-lttng
    - GIT_URL: https://github.com/michaelsevilla/ceph.git
    - SHA1_OR_REF: remotes/origin/wip-reqlatency

- hosts: Workers
  vars:  [TRACEPOINT: "mds:req*", CONTAINER: "ceph", STARTUP: "singlenode.sh"]
  roles: [ceph, lttng, ceph-client]
  tasks: 
    - command:  docker exec --detach ceph-client ceph-fuse /mnt/ -d
    - command:  docker exec ceph-client mdtest -F -C -n 10000 -d /mnt/testdir
      register: result
    - debug:    var=result.stdout_lines
    - command:  docker exec ceph lttng stop

- hosts: Builder
  roles: [parser]
