# Author: Michael Sevilla
# Deploy a Tachyon development node

- name: start tachyon containers on all hosts
  hosts: all
  gather_facts: no
  roles: [tachyon]

- name: add the tachyon masters to the hosts
  hosts: TachyonMasters
  tasks:
    - add_host: name={{ inventory_hostname }} 
                ansible_ssh_user=root 
                ansible_ssh_port=2222
                group=tachyon_master_containers

- name: add the tachyon workers to the hosts
  hosts: TachyonWorkers
  tasks:
    - add_host: name={{ inventory_hostname }} 
                ansible_ssh_user=root 
                ansible_ssh_port=2222
                group=tachyon_worker_containers

- name: configure tachyon
  hosts: tachyon_worker_containers,tachyon_master_containers
  tasks:
    - name: create a tachyon environment variables file
      shell: cp /tachyon/conf/tachyon-env.sh.template /tachyon/conf/tachyon-env.sh
    - name: set master address to the master
      lineinfile: dest=/tachyon/conf/tachyon-env.sh 
                  regexp="^export TACHYON_MASTER_ADDRESS=" 
                  insertafter="^#export TACHYON_MASTER_ADDRESS=" 
                  line="export TACHYON_MASTER_ADDRESS="{{ groups['TachyonMasters'][0] }}
    - name: set worker addresses to the workers
      copy: content="{{ groups['TachyonWorkers'][0] }}\n" dest=/tachyon/conf/workers
    #- name: set journal folder as a shared undered folder in underfs
    #  lineinfile: dest={{ tmpdir }}/tachyon/conf/tachyon-site.properties
    #              line="tachyon.master.journal.folder=${tachyon.underfs.address}/tachyon/journal/"


- name: start the masters
  hosts: tachyon_master_containers
  gather_facts: no
  tasks: 
      - shell: /tachyon/bin/tachyon-start.sh master -f

- name: start the workers
  hosts: tachyon_worker_containers
  gather_facts: no
  tasks:
    - shell: /tachyon/bin/tachyon-start.sh worker SudoMount
