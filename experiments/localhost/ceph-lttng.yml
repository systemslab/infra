# Author: Michael Sevilla
# Create a Ceph development node (with the source code) and start it on the localhost

- hosts: Workers
  roles: [cleanup]

#- name: compile ceph src
#  hosts: Builder
#  roles: [ceph-build]
#  vars:
#    - BUILD_THREADS: 64
#    - CEPH_PKGS: --with-lttng
#    - GIT_URL: https://github.com/michaelsevilla/ceph.git
#    - SHA1_OR_REF: remotes/origin/wip-reqlatency

- include: helpers/pause.yml
 
- name: start ceph daemons and lttng
  hosts: Workers
  vars:
    - TRACEPOINT: "mds:req*"
    - CONTAINER: cephdev
    - STARTUP: "singlenode.sh"
  roles: [ceph, lttng]


- include: helpers/pause.yml

- name: mount CephFS and run a benchmark
  hosts: Workers
  roles: [ceph-fuse]
  tasks:
    - command: docker exec cephdev-fuse mdtest -F -C -n 10000 -d /mnt/testdir
      register: result
    - debug: var=result.stdout_lines

- include: helpers/pause.yml
   
- name: stop lttng
  hosts: Workers
  tasks:
    - command: docker exec cephdev lttng stop

- include: helpers/pause.yml

- name: print out the results
  hosts: Builder
  roles: [visualizer]
