# Author: Michael Sevilla
# Create a Ceph development node (with the source code) and start it on the localhost
- hosts: all
  roles: [cleanup]

- name: compile ceph src
  hosts: Builder
  roles: [mantle-build]
  vars:
    - BUILD_THREADS: 64
    - CEPH_PKGS: --with-mantle
    - GIT_URL: https://github.com/michaelsevilla/ceph.git
    - SHA1_OR_REF: remotes/origin/wip-mantle-dev

- name: start ceph container
  hosts: Workers
  roles: [mantle]
  tasks:
    - name: start ceph daemons
      command: docker exec cephdev /ceph-scripts/standalone.sh

- name: start ceph client
  hosts: Builder
  roles: [ceph-client]
  tasks:
    - command: docker exec ceph-client ceph -s
      register: result
      changed_when: False
      async: 10
      poll: 1
    - debug: var=result.stdout_lines

- hosts: Workers
  tasks:
    - name: inject greedy spill balancer
      command: docker exec cephdev /ceph-scripts/greedy-spill.sh
      register: result
    - debug: var=result.stdout_lines

- hosts: Workers
  roles: [ceph-fuse]
