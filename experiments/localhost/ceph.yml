# Author: Michael Sevilla
# Create a Ceph development node (with the source code) and start it on the localhost
- hosts: all
  roles: [cleanup]

#- name: compile ceph src
#  hosts: Builder
#  vars:
#    - BUILD_THREADS: 32
#    - CEPH_PKGS: --with-lttng
#    - GIT_URL: https://github.com/michaelsevilla/ceph.git
#    - SHA1_OR_REF: remotes/origin/wip-reqlatency
#  roles: [ceph-build]

- name: start ceph container
  hosts: Workers
  roles: [ceph]
  tasks:
    - name: start ceph daemons
      command: docker exec cephdev /ceph-scripts/standalone.sh

- name: start ceph client
  hosts: Builder
  roles: [ceph-client]

- name: check to see if ceph started; timeout if it takes too long
  hosts: Builder
  tasks:
    - command: docker exec ceph-client ceph -s
      register: result
      changed_when: False
      async: 10
      poll: 1
    - debug: var=result.stdout_lines

