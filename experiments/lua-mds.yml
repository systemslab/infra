# Author: Michael Sevilla
# Bring up Ceph with object interfaces on a single node

- name: cleanup old experiments
  hosts: all
  tasks:
    - command: docker stop ceph lua-rados
      ignore_errors: True
    - command: docker rm ceph lua-rados
      ignore_errors: True
    - command: sudo rm -r /tmp/ceph_data/ /tmp/etc/ceph/
      ignore_errors: True
    
#- hosts: localhost
#  roles:
#    - role:     ceph/build
#      threads:  "64"
#      code_dir: "/tmp/docker/src/mantlev"

- name:  Start Ceph and setup the object interfaces
  hosts: Workers
  roles: [{role: ceph/deploy, startup: "small.sh", code_dir: "/tmp/docker/src/mantlev"}]
  tasks:
    - command: docker exec ceph mkdir -p /usr/local/lib/rados-classes/ /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_hello.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_lua.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libbal_lua.so /usr/local/lib/rados-classes/libcls_bal.so
    - command: docker exec ceph cp /ceph/src/cls/hello/cls_hellolua.lua /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph cp /ceph/src/bal/hello/bal_hellolua.lua /usr/local/share/ceph/rados-classes/cls_bal_hellolua.lua

- hosts: localhost
  tasks:
    - debug: msg="docker exec -it ceph /bin/bash"
    - debug: msg="docker exec -it ceph tail -f /var/log/ceph/ceph-mds.0.log"
