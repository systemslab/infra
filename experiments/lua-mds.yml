# Author: Michael Sevilla
# Bring up Ceph with object interfaces on a single node

- hosts: all
  #roles: [cleanup]
  tasks: 
    - shell: sudo rm -r /tmp/etc/ /tmp/ceph_data/ /usr/local/share/ceph/rados-classes/
      ignore_errors: True
      no_log: True
    - shell: docker stop ceph cleaner lua-rados
      ignore_errors: True
      no_log: True
    - shell: docker rm ceph cleaner lua-rados
      ignore_errors: True
      no_log: True

    
#- hosts: localhost
#  roles:
#    - role:     ceph/build
#      threads:  "64"
#      code_dir: "/tmp/docker/src/mantlev"

- name:  Start Ceph and setup the object interfaces
  hosts: Workers
  #roles: [{role: ceph/deploy, startup: "small.sh", code_dir: "/tmp/docker/src/lua-rados"}]
  roles: [{role: ceph/deploy, startup: "small.sh", code_dir: "/tmp/docker/src/mantlev"}]
  tasks:
    - command: docker exec ceph mkdir -p /usr/local/lib/rados-classes/ /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_hello.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_lua.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_bal_lua.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/cls/hello/cls_hellolua.lua /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph ln -s /ceph/src/bal/hello/cls_bal_hellolua.lua /usr/local/share/ceph/rados-classes/cls_bal_hellolua.lua
    - command: docker exec ceph ln -s /ceph/src/bal/helpers/libmantle.lua /usr/local/share/ceph/rados-classes/libmantle.lua
    - command: docker exec ceph ln -s /ceph/src/bal/greedyspill/cls_bal_greedyspill.lua /usr/local/share/ceph/rados-classes/cls_bal_greedyspill.lua

- name:  Run the Lua-RADOS bindings unit tests
  hosts: Clients
  roles: [lua-rados/build]
  tasks:
    - command:  docker exec lua-rados busted lua-rados/test.lua
      register: result
    - debug:    var=result.stdout_lines
