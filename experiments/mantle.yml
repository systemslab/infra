# Author: Michael Sevilla
# Bring up Ceph with Mantle on a single node

- hosts: all
  roles: [cleanup]

- hosts: Builder
  roles: 
    - role:     mantle/build
      code_dir: "/tmp/docker/src/mantle"
      git_url:  "https://github.com/michaelsevilla/ceph.git"
      commit:   "remotes/origin/wip-mantle-dev"
      pkgs:     "--with-mantle"
      threads:  "64"

- name:  Start Mantle and set the balancer to greedy-spill
  hosts: Workers
  roles: [{role: mantle/deploy, startup: "standalone.sh"}]
  tasks: [command: docker exec mantle /mantle-scripts/greedy-spill.sh]

- name:  Mount the file system and run a short benchmark
  hosts: Builder
  roles: [{role: ceph/deploy, startup: "none", container: client, sshd_port: 2223}]
  tasks:
    - command:  docker exec -d client ceph-fuse /mnt/ -d
    - command:  docker exec    client mdtest -F -C -n 10000 -d /mnt/testdir
      register: result
    - debug:    var=result.stdout_lines
