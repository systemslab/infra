# Author: Michael Sevilla
# Bring up Ceph with object interfaces on a single node

- name: Cleanup my workspace
  hosts: all
  roles:
    - role: cleanup
      containers: "ceph lua-rados"

- name:  Start Ceph and setup the object and balancer interfaces
  hosts: Workers
  roles: [{role: ceph/deploy, startup: "small.sh", code_dir: "/home/msevilla/code/mantlev"}]
  tasks:
    - name: Link the C++ object classes into the local file system
      command: docker exec ceph mkdir -p /usr/local/lib/rados-classes/ /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_hello.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_lua.so /usr/local/lib/rados-classes/
    - command: docker exec ceph cp /ceph/src/.libs/libcls_bal_lua.so /usr/local/lib/rados-classes/

    - name: Link the Lua balancers into the local file system
      command: docker exec ceph cp /ceph/src/cls/hello/cls_hellolua.lua /usr/local/share/ceph/rados-classes/
    - command: docker exec ceph ln -s /ceph/src/mds/mantle/bal/hello/cls_bal_hellolua.lua /usr/local/share/ceph/rados-classes/cls_bal_hellolua.lua
    - command: docker exec ceph ln -s /ceph/src/mds/mantle/bal/greedyspill/cls_bal_greedyspill.lua /usr/local/share/ceph/rados-classes/cls_bal_greedyspill.lua
    - command: docker exec ceph ln -s /ceph/src/mds/mantle/bal/lua/libmantle.lua /usr/local/share/ceph/rados-classes/libmantle.lua


- name:  Run the Lua-RADOS bindings unit tests
  hosts: Clients
  roles: [lua-rados/build]
  tasks:
    - command: docker exec ceph-build /ceph/src/ceph_test_cls_lua
      ignore_errors: True
      no_log: True
    - command: docker exec ceph-build /ceph/src/rados
      ignore_errors: True
      no_log: True

    - name:     Run the Lua object interface unit tests
      command:  docker exec ceph /ceph/src/ceph_test_cls_lua
      register: result
    - debug:    var=result.stdout_lines
    - name:     Run the Lua object interface integration tests
      command:  docker exec lua-rados busted ceph-scripts/test.lua
      register: result
    - debug:    var=result.stdout_lines

- name: Setup Lua scripts so MDS can pick them up
  hosts: Clients
  tasks:
    - name: Push the balancers into RADOS
      command: docker exec ceph rados put -p cephfs_metadata cls_bal_greedyspill.lua /ceph/src/mds/mantle/bal/greedyspill/cls_bal_greedyspill.lua 
    - command: docker exec ceph rados put -p cephfs_metadata cls_bal_hellolua.lua /ceph/src/mds/mantle/bal/hello/cls_bal_hellolua.lua
    - command: docker exec ceph ceph mds set lua_balancer_script "hello-test.lua"

- name:  Run the Lua-RADOS bindings unit tests
  hosts: Clients
  roles: [lua-rados/build]
  tasks:
    - command: docker exec ceph-build /ceph/src/ceph_test_cls_lua
      ignore_errors: True
      no_log: True

    - command: docker exec ceph-build /ceph/src/rados
      ignore_errors: True
      no_log: True

    - command:  docker exec ceph /ceph/src/ceph_test_cls_lua
      register: result
    - debug:    var=result.stdout_lines
    - command:  docker exec lua-rados busted ceph-scripts/test.lua
      register: result
    - debug:    var=result.stdout_lines

