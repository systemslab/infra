# Author: Michael Sevilla
# Create a Tachyon node (with the source code)

- name: pull dependencies for running tachyon
  ignore_errors: True
  no_log: True
  docker: 
    image: michaelsevilla/tachyondev
    state: present

- name: start tachyon container 
  docker:
    image: michaelsevilla/tachyondev
    name: "{{ container }}"
    state: restarted
    detach: yes
    tty: yes
    net: host
    privileged: yes
    env:
      SSHD_PORT: "{{ sshd_port }}"
      AUTHORIZED_KEYS: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    volumes: 
      - "{{ code_dir }}/tachyon:/tachyon"

- name: format tachyon in the container
  command: docker exec {{ container }} /tachyon/bin/tachyon format
  changed_when: False
  when: startup == True

- name: start tachyon daemon in the container
  command: docker exec {{ container }} /tachyon/bin/tachyon-start.sh local
  changed_when: False
  when: startup == True
